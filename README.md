# github-oidc-vault-example
Example repo demonstrating access to Vault secrets through GitHub OIDC auth.

For a proof of concept, create an Ubuntu 20.04 Droplet and follow [Hashicorp's instructions]() to apt install `vault`.

Also install [mkcert](https://github.com/FiloSottile/mkcert) to create a self-signed certificate for Vault.
The [hashicorp/vault-action](https://github.com/hashicorp/vault-action) requires Vault to use HTTPS.

In a command line on the server, run:

```bash
# Self-sign certificate for Vault
mkcert install
mkcert [public ip address] localhost 127.0.0.1 ::1
# Note the file names of the cert and key generated by mkcert!
# Set up a minimally-configured Vault server
# Update [mkcert filename] with the appropriate name from the output of the previous command
echo '
> storage "file" {
>   path = "/root/vault-data"
> }
>
> listener "tcp" {
>   address = "0.0.0.0:443"
>   tls_cert_file = "/root/[mkcert filename].pem"
>   tls_key_file = "/root/[mkcert filename]-key.pem"
> }
>
> ui = true
> disable_mlock = true
> ' > vault-config.hcl
vault server -config vault-config.hcl
# Proceed to https://<IP>/ and prepare unseal keys for Vault.
# Follow the UI prompts to unseal Vault.
#
# Open up a second terminal and run the rest:
export VAULT_ADDR='https://0.0.0.0:443'
vault login [token from server -dev command]
# I like to see the audit log on stdout in the first terminal while having a file to refer back to if needed
vault audit enable file file_path=stdout log_raw=true
vault audit enable -path="vault_audit_file" file file_path=/root/vault_audit.log
# Set up a secret and a test policy that will be used by our 2 roles
vault secrets enable -path=secret kv-v2
vault kv put secret/foo/bar fi=fofum
echo '
path "secret/foo/bar" {
    capabilities = ["list", "read"]
}
' > policy.hcl
vault policy write oidc-policy policy.hcl
```

Now run `make apply` in the terraform module repo to configure the OIDC auth backend and the example roles used in this repo.
